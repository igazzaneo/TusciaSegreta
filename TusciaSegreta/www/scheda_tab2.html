<div>
    <div id="mapid3" style="width: 100%; height: 100%;"></div>
    <div id="elevation-div" style="width: 100%; height: 0%;display: none;"></div>
    <div id="toast" style="width: 100%">
      <div id="img">Icon</div>
      <div id="name">Nome:</div>
      <div id="desc">Descrizione:</div>
    </div>

    <!--br/>
    <div>
      <ons-list>
        <ons-list-item>
          <ons-row>
            <ons-col width="50px"><ons-icon icon="fa-arrow-right" class="list-item__icon"></ons-icon></ons-col>
            <ons-col>Lunghezza: 2,1 Km</ons-col>
            <ons-col width="50px"><ons-icon icon="fa-arrow-up" class="list-item__icon"></ons-icon></ons-col>
            <ons-col>Dislivello: 50m</ons-col>
          </ons-row>
        </ons-list-item>

        <ons-list-item>
          <ons-row>
            <ons-col width="50px"><ons-icon icon="fa-play" rotate="270" class="list-item__icon"></ons-icon></ons-col>
            <ons-col>Difficolt√†: Facile</ons-col>
            <ons-col width="50px"><ons-icon modifier="other" icon="fa-clock" class="list-item__icon"></ons-icon></ons-col>
            <ons-col>Durata prevista: 25 m</ons-col>
          </ons-row>
        </ons-list-item>

        <ons-list-item>
          <ons-row>
            <ons-col width="50px"><ons-icon icon="fa-undo-alt" class="list-item__icon"></ons-icon></ons-col>
            <ons-col>Percorso ad anello: NO</ons-col>
          </ons-row>
        </ons-list-item>

        <ons-list-item>
          <ons-row>
            <ons-col width="50px"><ons-icon icon="fa-battery-three-quarters" rotate="270" class="list-item__icon"></ons-icon></ons-col>
            <ons-col>Batteria: consigliati caricatori</ons-col>
            <ons-col width="50px"><ons-icon modifier="other" icon="fa-wifi" class="list-item__icon"></ons-icon></ons-col>
            <ons-col>Rete mobile: assente</ons-col>
          </ons-row>
        </ons-list-item>
      </ons-list>
    </div>
    <br-->
    <!--div id="commenti">
      <div>
        <table style="width: 100%;">
        <tbody>
          <tr><td>test ha detto:</td></tr>
          <tr><td>Testo del commento</td></tr>
          <tr><td><div id='trail-rating'><ul class='ratings'><li class='average'><span id='rating' class='rating star3_5'>&nbsp;</span></li></ul></div></td></tr>
        </tbody>
        </table>
      </div>
      <div><hr class="style-three"></div>
    </div-->

  <script>

    var lc;

    var roads = L.gridLayer.googleMutant({
       type: 'roadmap'	// valid values are 'roadmap', 'satellite', 'terrain' and 'hybrid'
    })

    var satellite = L.gridLayer.googleMutant({
       type: 'satellite'	// valid values are 'roadmap', 'satellite', 'terrain' and 'hybrid'
    })

    var terrain = L.gridLayer.googleMutant({
       type: 'terrain'	// valid values are 'roadmap', 'satellite', 'terrain' and 'hybrid'
    })

    var hybrid = L.gridLayer.googleMutant({
       type: 'hybrid'	// valid values are 'roadmap', 'satellite', 'terrain' and 'hybrid'
    })

    var options = {
      icon: 'fas fa-map-pin',
      iconShape: 'marker',
      borderColor: '#000000',
      borderWidth: 2,
      iconSize: [25, 25],
      popupAnchor: [-1, -32],
      textColor: '#000000'
    };

    var map = new L.Map('mapid3',{
        center: new L.LatLng(42.585280, 11.933396),
        zoom: 9,
        layers: [roads]
    });

    // Bottone sulla mappa per elevationdiv
    L.easyButton('fa-mountain', function(btn, map){
      if($('#elevation-div').css('display') == 'inline-block')
      {
        $("#mapid3").css('height', '100%');
        $("#elevation-div").css('display', 'none').css('height', '0%');
      } else {
        $("#mapid3").css('height', '65%');
        $("#elevation-div").css('display', 'inline-block').css('height', '35%');
      }

    }).addTo( map );


    //map.locate({setView: true, watch: true, maxZoom: 20});
    //map.on('locationfound', onLocationFound);
    //map.on('locationerror', onLocationError);

    var baseLayers = {
        "Standard": roads,
        "Satellite": satellite,
        "Altimetria": terrain,
        "Ibrido": hybrid
    };

    L.control.layers(baseLayers).addTo(map);

    var percorso = localStorage.getObj("percorso");

    var elevationControl = {
      //url: "https://raruto.github.io/examples/leaflet-elevation/via-emilia.gpx",
      //url: "gpx/eremo-di-poggio-conte2.gpx",
      //url: percorso[3],
      url: "gpx/test.gpx",
      options: {
        position: "topleft",
        theme: "magenta-theme", //default: lime-theme
        useHeightIndicator: false, //if false a marker is drawn at map position
        interpolation: d3.curveLinear, //see https://github.com/d3/d3/wiki/
        collapsed: false, //collapsed mode, show chart on click or mouseover
        elevationDiv: "#elevation-div",
        detachedView: true,
        responsiveView: true,
      },
    };

    var controlElevation = L.control.elevation(elevationControl.options);
    controlElevation.loadGPX(map, elevationControl.url);

    lc = L.control.locate({
      position: 'topleft',
      clickBehavior: {
        inView: 'setView',
        outOfView: 'setView',
        inViewNotFollowing: 'setView'
      },
      cacheLocation: false,
      icon: "far fa-dot-circle",
      locatOptions: {
        enableHighAccuracy: true
      }
    }).addTo(map);
    lc.start();


    var startOptions = {
      icon: 'fas fa-flag',
      iconShape: 'marker',
      borderColor: '#000000',
      borderWidth: 2,
      iconSize: [35, 35],
      popupAnchor: [-1, -32],
      textColor: '#00FF00',
      customClasses: 'fa-2x'
    };

    var endOptions = {
      icon: 'fas fa-flag-checkered',
      iconShape: 'marker',
      borderColor: '#000000',
      borderWidth: 2,
      iconSize: [35, 35],
      popupAnchor: [-1, -32],
      textColor: '#FF0000',
      customClasses: 'fa-2x'
    };

    var current_position;
    var i=0;
    var nodi = localStorage.getObj("nodi");

    function getPosizioneAttuale() {

        getMapLocation();

        var latitudine = getValueFromLocalStorage('latitudine');
        var longitudine = getValueFromLocalStorage('longitudine');

        var options = {
          icon: 'fas fa-chevron-circle-up',
          borderColor: '#000000',
          borderWidth: 1,
          iconSize: [20, 20],
          popupAnchor: [5, -6],

        };
        i=i+1;
        if (current_position) {
            current_position.setLatLng([latitudine, longitudine]);
        } else {

            current_position = L.marker([latitudine, longitudine], {
              icon: L.BeautifyIcon.icon(options),
              draggable: false}).addTo(map).bindPopup("Sei qui");//.openPopup();
        }

        for(var x=0; x<nodi.length; x++) {

            var nodo = nodi[x];
            //showMessage(nodo);
            var to = L.marker([nodo[1], nodo[2]]);

            var distanzaInMetri = current_position.getLatLng().distanceTo(to.getLatLng());

            if(distanzaInMetri<20) {
              showMessage("Hai raggiunto PDI: " + nodo[5]);
            }
        }

        setTimeout(getPosizioneAttuale, 5000);
    }

    function stopFollowing()
    {
      showMessage("StopFollowing");
      lc.stop();

    }

    function verificaNodo(e)
    {

      for(var x=0; x<nodi.length; x++) {

          var nodo = nodi[x];
          var to = L.marker([nodo[1], nodo[2]]);

          var distanzaInMetri = e.latlng.distanceTo(to.getLatLng());

          if(distanzaInMetri<20) {
            //showMessage("Hai raggiunto PDI: " + nodo[5]);
            $("#name").html(nodo[5]);
            $("#desc").html(nodo[4]);
            var x = document.getElementById("toast")
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 5000);
          }
      }

    }


    getPosizioneAttuale();

    </script>


</div>
