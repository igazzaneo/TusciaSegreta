<ons-page id="Scelta">

    <div id="mapid3" style="width: 100%; height: 50%;"></div>
    <div id="elevation-div" style="width: 100%; height: 35%;"></div>
    <br/>
    <div>
      <ons-list>
        <ons-list-item>
          <ons-row>
            <ons-col width="50px"><ons-icon icon="fa-arrow-right" class="list-item__icon"></ons-icon></ons-col>
            <ons-col>Lunghezza: 2,1 Km</ons-col>
            <ons-col width="50px"><ons-icon icon="fa-arrow-up" class="list-item__icon"></ons-icon></ons-col>
            <ons-col>Dislivello: 50m</ons-col>
          </ons-row>
        </ons-list-item>

        <ons-list-item>
          <ons-row>
            <ons-col width="50px"><ons-icon icon="fa-play" rotate="270" class="list-item__icon"></ons-icon></ons-col>
            <ons-col>Difficolt√†: Facile</ons-col>
            <ons-col width="50px"><ons-icon modifier="other" icon="fa-clock" class="list-item__icon"></ons-icon></ons-col>
            <ons-col>Durata prevista: 25 m</ons-col>
          </ons-row>
        </ons-list-item>

        <ons-list-item>
          <ons-row>
            <ons-col width="50px"><ons-icon icon="fa-undo-alt" class="list-item__icon"></ons-icon></ons-col>
            <ons-col>Percorso ad anello: NO</ons-col>
          </ons-row>
        </ons-list-item>

        <ons-list-item>
          <ons-row>
            <ons-col width="50px"><ons-icon icon="fa-battery-three-quarters" rotate="270" class="list-item__icon"></ons-icon></ons-col>
            <ons-col>Batteria: consigliati caricatori</ons-col>
            <ons-col width="50px"><ons-icon modifier="other" icon="fa-wifi" class="list-item__icon"></ons-icon></ons-col>
            <ons-col>Rete mobile: assente</ons-col>
          </ons-row>
        </ons-list-item>
      </ons-list>
    </div>
    <br>
    <div id="commenti">
      <div>
        <table style="width: 100%;">
        <tbody>
          <tr><td>test ha detto:</td></tr>
          <tr><td>Testo del commento</td></tr>
          <tr><td><div id='trail-rating'><ul class='ratings'><li class='average'><span id='rating' class='rating star3_5'>&nbsp;</span></li></ul></div></td></tr>
        </tbody>
        </table>
      </div>
      <div><hr class="style-three"></div>
    </div>

  <script>

    var roads = L.gridLayer.googleMutant({
       type: 'roadmap'	// valid values are 'roadmap', 'satellite', 'terrain' and 'hybrid'
    })

    var satellite = L.gridLayer.googleMutant({
       type: 'satellite'	// valid values are 'roadmap', 'satellite', 'terrain' and 'hybrid'
    })

    var terrain = L.gridLayer.googleMutant({
       type: 'terrain'	// valid values are 'roadmap', 'satellite', 'terrain' and 'hybrid'
    })

    var hybrid = L.gridLayer.googleMutant({
       type: 'hybrid'	// valid values are 'roadmap', 'satellite', 'terrain' and 'hybrid'
    })

    var options = {
      icon: 'fas fa-map-pin',
      iconShape: 'marker',
      borderColor: '#000000',
      borderWidth: 2,
      iconSize: [25, 25],
      popupAnchor: [-1, -32],
      textColor: '#000000'
    };

    var map = new L.Map('mapid3',{
        center: new L.LatLng(42.585280, 11.933396),
        zoom: 9,
        layers: [roads]
    });

    map.locate({setView: true, watch: true, maxZoom: 20});
    //map.on('locationfound', onLocationFound);
    //map.on('locationerror', onLocationError);

    var baseLayers = {
        "Standard": roads,
        "Satellite": satellite,
        "Altimetria": terrain,
        "Ibrido": hybrid
    };

    L.control.layers(baseLayers).addTo(map);

    var percorso = localStorage.getObj("percorso");
//showMessage(percorso[3]);
    var elevationControl = {
      //url: "https://raruto.github.io/examples/leaflet-elevation/via-emilia.gpx",
      //url: "gpx/eremo-di-poggio-conte2.gpx",
      //url: percorso[3],
      url: "gpx/test.gpx",
      options: {
        position: "topleft",
        theme: "magenta-theme", //default: lime-theme
        useHeightIndicator: true, //if false a marker is drawn at map position
        interpolation: d3.curveLinear, //see https://github.com/d3/d3/wiki/
        collapsed: false, //collapsed mode, show chart on click or mouseover
        elevationDiv: "#elevation-div",
        detachedView: true,
        responsiveView: true,
      },
    };

    var controlElevation = L.control.elevation(elevationControl.options);
    controlElevation.loadGPX(map, elevationControl.url);

    //var gpx = 'gpx/eremo-di-poggio-conte2.gpx'; // URL to your GPX file or the GPX itself



    var startOptions = {
      icon: 'fas fa-flag',
      iconShape: 'marker',
      borderColor: '#000000',
      borderWidth: 2,
      iconSize: [35, 35],
      popupAnchor: [-1, -32],
      textColor: '#00FF00',
      customClasses: 'fa-2x'
    };

    var endOptions = {
      icon: 'fas fa-flag-checkered',
      iconShape: 'marker',
      borderColor: '#000000',
      borderWidth: 2,
      iconSize: [35, 35],
      popupAnchor: [-1, -32],
      textColor: '#FF0000',
      customClasses: 'fa-2x'
    };

    //console.log("GPX FILE:"  + gpx);
    /*new L.GPX(gpx, {
      async: true,
      marker_options: {
        startIconUrl: 'img/pin-icon-start.png',
        endIconUrl: 'img/pin-icon-end.png',
        shadowUrl: 'img/pin-shadow.png',

        wptIcons: {
          '': new L.BeautifyIcon.icon(options)
        }
      }
    }).on('loaded', function(e) {
      console.log("loaded");
      var gpx = e.target;
      mymap.fitBounds(gpx.getBounds());
      control.addOverlay(gpx, gpx.get_name());
    }).addTo(mymap);*/


    var current_position;
    var i=0;

    function getPosizioneAttuale() {

        getMapLocation();

        var latitudine = getValueFromLocalStorage('latitudine');
        var longitudine = getValueFromLocalStorage('longitudine');

        var options = {
          icon: 'fas fa-map-marker-alt',
          borderColor: '#000000',
          borderWidth: 1,
          iconSize: [20, 20],
          popupAnchor: [5, -6],

        };
        i=i+1;
        if (current_position) {
            //map.removeLayer(current_position);
            //showMessage("riposizione marker...");
            current_position.setLatLng([latitudine, longitudine]);
        } else {

            current_position = L.marker([latitudine, longitudine], {
              icon: L.BeautifyIcon.icon(options),
              draggable: false}).addTo(map).bindPopup("Sei qui").openPopup();

        }

       var nodi = localStorage.getObj("nodi");
showMessage(nodi);
        /*for(var x=0; x<nodi.length; x++) {

            var nodo = nodi[x];

            var to = L.marker([nodo[1], nodo[2]);

            var distanzaInMetri = current_position.getLatLng().distanceTo(to.getLatLng());

            if(distanzaInMetri<20) {
              showMessage("Hai raggiunto PDI: " + nodo[5]);
            }
        }*/

        setTimeout(getPosizioneAttuale, 5000);
    }


    getPosizioneAttuale();

    </script>
</ons-page>
